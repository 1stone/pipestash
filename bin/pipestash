#!/usr/bin/env python

import pipestash
import pipestash.producer
import pipestash.consumer
import pipestash.output.redisoutput
import multiprocessing

def main():
    config = pipestash.parseargs()

    # create queue
    queue = multiprocessing.Queue()

    # instantiate output plugin
    output = pipestash.output.redisoutput.RedisOutput(config)

    # function to create the consumer
    def createconsumer():
        proc = multiprocessing.Process(target = pipestash.consumer.consume, args = [queue, output])
        proc.start()
        return proc

    consumer = pipestash.producer.produce(config, queue, createconsumer)

    while True:
        consumer.join()
        if consumer.exit_code != 0:
            consumer = createconsumer()
        else:
            break

if __name__ == "__main__":
    main()
